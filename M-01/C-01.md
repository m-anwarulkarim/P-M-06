### ржлрж╛ржЗрж▓ рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░

```
src/
тФЬтФАтФА utils/
тФВ   тФЬтФАтФА AppError.ts          тЖР ржХрж╛рж╕рзНржЯржо ржПрж░рж░ ржХрзНрж▓рж╛рж╕
тФВ   тФФтФАтФА asyncHandler.ts      тЖР catchAsync ржПрж░ ржмржжрж▓рзЗ ржПржЗ ржирж╛ржоржЯрж╛ ржмрзЗрж╢рж┐ intuitive & ржХржоржи
тФФтФАтФА middleware/
    тФФтФАтФА errorHandler.ts      тЖР ржЧрзНрж▓рзЛржмрж╛рж▓ ржПрж░рж░ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ (errorMiddleware ржПрж░ ржЪрзЗржпрж╝рзЗ ржнрж╛рж▓рзЛ)
```

(ржЕржирзЗржХ ржкрзНрж░ржЬрзЗржХрзНржЯрзЗ `errors/` ржлрзЛрж▓рзНржбрж╛рж░ржУ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ, ржХрж┐ржирзНрждрзБ `utils/` ржжрж┐ржпрж╝рзЗ рж╢рзБрж░рзБ ржХрж░рж▓рзЗ рж╕рж┐ржорзНржкрж▓ ржерж╛ржХрзЗред)

### рзз. `src/utils/AppError.ts`

ржПржЯрж┐ ржПрж░рж░ржЧрзБрж▓рзЛржХрзЗ ржПржХржЯрж┐ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржлрж░ржорзНржпрж╛ржЯрзЗ рж╕рж╛ржЬрж╛рждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░ржмрзЗред

```typescript
// src/utils/AppError.ts
class AppError extends Error {
  public statusCode: number;
  public status: "fail" | "error";
  public isOperational: boolean;

  constructor(message: string, statusCode: number) {
    super(message);

    this.statusCode = statusCode;
    this.status = `${statusCode}`.startsWith("4") ? "fail" : "error";
    this.isOperational = true;

    Error.captureStackTrace(this, this.constructor);
  }
}

export default AppError;
```

### рзи. `src/utils/asyncHandler.ts` (catchAsync ржПрж░ ржмржжрж▓рзЗ)

ржПржЯрж┐ async ржлрж╛ржВрж╢ржиржЧрзБрж▓рзЛ ржерзЗржХрзЗ ржПрж░рж░ ржзрж░рзЗ ржЕржЯрзЛржорзЗржЯрж┐ржХ next()-ржП ржкрж╛ржарж┐рзЯрзЗ ржжрзЗржмрзЗред ржлрж▓рзЗ ржЖрж░ ржмрж╛рж░ржмрж╛рж░ try-catch рж▓рж┐ржЦрждрзЗ рж╣ржмрзЗ ржирж╛ред

```typescript
// src/utils/asyncHandler.ts
import { Request, Response, NextFunction } from "express";

type AsyncRequestHandler = (
  req: Request,
  res: Response,
  next: NextFunction,
) => Promise<any>;

export const asyncHandler = (fn: AsyncRequestHandler) => {
  return (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};
```

### рзй. `src/middleware/errorHandler.ts` (ржЧрзНрж▓рзЛржмрж╛рж▓ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░)

ржкрзБрж░рзЛ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗрж░ рж╕ржм ржПрж░рж░ ржПржХ ржЬрж╛рзЯржЧрж╛ ржерзЗржХрзЗ ржорзНржпрж╛ржирзЗржЬ рж╣рзЯред ржпржжрж┐ ржХржЦржирзЛ ржПрж░рж░рзЗрж░ ржлрж░ржорзНржпрж╛ржЯ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ рж╣рзЯ, рж╢рзБржзрзБ ржПржЗ ржПржХ ржЬрж╛рзЯржЧрж╛рзЯ ржХрж░рж▓рзЗржЗ ржкрзБрж░рзЛ ржЕрзНржпрж╛ржкрзЗ ржХрж╛ржЬ ржХрж░ржмрзЗред

```typescript
// src/middleware/errorHandler.ts
import { Request, Response, NextFunction } from "express";
import AppError from "../utils/AppError";

const errorHandler = (
  err: any,
  req: Request,
  res: Response,
  next: NextFunction,
) => {
  // ржбрж┐ржлрж▓рзНржЯ ржнрзНржпрж╛рж▓рзБ рж╕рзЗржЯ ржХрж░рж╛
  err.statusCode = err.statusCode || 500;
  err.status = err.status || "error";

  // development vs production
  if (process.env.NODE_ENV === "development") {
    return res.status(err.statusCode).json({
      status: err.status,
      message: err.message,
      error: err,
      stack: err.stack,
    });
  }

  // ржкрзНрж░рзЛржбрж╛ржХрж╢ржирзЗ рж╢рзБржзрзБ trusted (operational) ржПрж░рж░ ржжрзЗржЦрж╛ржмрзЗ
  if (err.isOperational) {
    return res.status(err.statusCode).json({
      status: err.status,
      message: err.message,
    });
  }

  // ржкрзНрж░рзЛржЧрзНрж░рж╛ржорж┐ржВ ржПрж░рж░ / ржЕржЬрж╛ржирж╛ ржПрж░рж░ тЖТ generic ржорзЗрж╕рзЗржЬ
  console.error("ERROR ЁЯТе", err);
  return res.status(500).json({
    status: "error",
    message: "Something went very wrong!",
  });
};

export default errorHandler;
```

### рзк. `src/app.ts` ржП рж╕ржм ржЬрзБржбрж╝рзЗ ржжрзЗржУржпрж╝рж╛ (ржЙржжрж╛рж╣рж░ржг)

```typescript
// src/app.ts
import express, { Request, Response, NextFunction } from "express";
import AppError from "./utils/AppError";
import { asyncHandler } from "./utils/asyncHandler";
import errorHandler from "./middleware/errorHandler";

const app = express();

// JSON ржкрж╛рж░рзНрж╕рж╛рж░ (ржпржжрж┐ рж▓рж╛ржЧрзЗ)
app.use(express.json());

// ржЙржжрж╛рж╣рж░ржг рж░рж╛ржЙржЯ
app.get(
  "/api/v1/users/:id",
  asyncHandler(async (req: Request, res: Response, next: NextFunction) => {
    const userId = req.params.id;

    // ржзрж░рзЛ ржбрж╛ржЯрж╛ржмрзЗржЬ ржерзЗржХрзЗ ржЗржЙржЬрж╛рж░ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐
    const user = null; // тЖР ржПржЦрж╛ржирзЗ ржЖрж╕рж▓ ржХрзЛржб ржерж╛ржХржмрзЗ

    if (!user) {
      return next(new AppError("ржПржЗ ржЖржЗржбрж┐ ржжрж┐ржпрж╝рзЗ ржХрзЛржирзЛ ржЗржЙржЬрж╛рж░ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐!", 404));
    }

    res.status(200).json({
      status: "success",
      data: user,
    });
  }),
);

// 404 рж░рж╛ржЙржЯ ржирж╛ ржкрзЗрж▓рзЗ
app.all("*", (req: Request, res: Response, next: NextFunction) => {
  next(new AppError(`Can't find ${req.originalUrl} on this server!`, 404));
});

// ржЧрзНрж▓рзЛржмрж╛рж▓ ржПрж░рж░ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ тАФ рж╕ржмрж╛рж░ рж╢рзЗрж╖рзЗ рж░рж╛ржЦрждрзЗ рж╣ржмрзЗ
app.use(errorHandler);

export default app;
```

### ржХрзЗржи ржПржЗ рзйржЯрж┐ ржПржХрж╕рж╛ржерзЗ рж╕рзЗрж░рж╛?

1. **`catchAsync`:** ржЖржкржирж╛рж░ ржХрзЛржб ржерзЗржХрзЗ ржЕрждрж┐рж░рж┐ржХрзНржд `try-catch` рж╕рж░рж┐рзЯрзЗ ржХрзЛржбржХрзЗ ржХрзНрж▓рж┐ржи рж░рж╛ржЦрзЗред
2. **`AppError`:** ржЖржкржирж┐ ржирж┐ржЬрзЗржЗ рж╕рж┐ржжрзНржзрж╛ржирзНржд ржирж┐рждрзЗ ржкрж╛рж░рзЗржи ржХрзЛржи ржнрзБрж▓рзЗрж░ ржЬржирзНржп ржХрж┐ ржорзЗрж╕рзЗржЬ ржПржмржВ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржХрзЛржб (`401`, `403`, `404`) ржпрж╛ржмрзЗред
3. **Global Handler:** ржкрзБрж░рзЛ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗрж░ рж╕ржм ржПрж░рж░ ржПржХ ржЬрж╛рзЯржЧрж╛ ржерзЗржХрзЗ ржорзНржпрж╛ржирзЗржЬ рж╣рзЯред ржпржжрж┐ ржХржЦржирзЛ ржПрж░рж░рзЗрж░ ржлрж░ржорзНржпрж╛ржЯ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рждрзЗ рж╣рзЯ, рж╢рзБржзрзБ ржПржЗ ржПржХ ржЬрж╛рзЯржЧрж╛рзЯ ржХрж░рж▓рзЗржЗ ржкрзБрж░рзЛ ржЕрзНржпрж╛ржкрзЗ ржХрж╛ржЬ ржХрж░ржмрзЗред
